{"version":3,"file":"index.esm.js","sources":["../src/MatchResult.js","../src/Route.js","../src/Router.js"],"sourcesContent":["export default class MatchResult {\n  constructor ({\n    input,\n    route = null,\n    url = null,\n    params = {},\n    redirect = false\n  }) {\n    this.input = input;\n    this.route = route;\n    this.params = params;\n    this.redirect = redirect;\n    this.original = null;\n    this.url = url || route.buildUrl(params);\n  }\n\n  isRedirect ({original}) {\n    this.redirect = true;\n    this.original = original;\n  }\n}\n","import Url from 'url';\nimport Querystring from 'querystring';\nimport {pathToRegexp, compile} from 'path-to-regexp';\n\nimport MatchResult from './MatchResult';\n\nfunction decodeParam ({name, value}) {\n  try {\n    return decodeURIComponent(value);\n  } catch (_) {\n    throw new Error(`Invalid value for ${name}`);\n  }\n}\n\nexport default class Route {\n  /**\n   * Represents a route\n   * @constructor\n   * @param {string} name - Name for the route.\n   * @param {string} pattern - Pattern used by path-to-regexp to match route.\n   * @param {Object} page - Page to be returned along with params for this route.\n   */\n  constructor (params) {\n    const required_params = ['name', 'pattern', 'page'];\n    for (const param of required_params) {\n      if (!(param in params)) {\n        throw new Error(`Missing route param ${param}`);\n      }\n    }\n\n    // Allow for dynamic params in routes to be used with\n    // custom redirects etc.\n    for (const [k, v] of Object.entries(params)) {\n      if (['match', 'buildUrl'].includes(k)) {\n        throw new Error(`Invalid route param ${k}`);\n      }\n      this[k] = v;\n    }\n\n    // create matcher for this route (uses path-to-regexp)\n    const options = {\n      sensitive: false,\n      strict: false,\n      end: true\n    };\n    this._param_keys = [];\n    this._matcher = pathToRegexp(this.pattern, this._param_keys, options);\n  }\n\n  /**\n  * Check whether this route matches a passed path or route.\n  * @return {MatchedRoute}\n  */\n  // you can either pass a path to match\n  match (args) {\n    const fn_name = `_match${args.url ? 'Url' : 'Route'}`;\n    return this[fn_name](args);\n  }\n\n  is (test) {\n    if (test.indexOf('/') !== -1) {\n      return !!this._matcher.exec(test);\n    } else {\n      return (this.name === test);\n    }\n  }\n\n  _matchUrl (input) {\n    const {url} = input;\n\n    const {\n      query: query_params,\n      pathname: path\n    } = Url.parse(url, true);\n\n    const match = this._matcher.exec(path);\n    if (!match) {\n      return false;\n    }\n\n    const route_params = this._getParamsFromMatch(match);\n    const params = {...route_params, ...query_params};\n\n    return new MatchResult({\n      route: this,\n      input,\n      params\n    });\n  }\n\n  // matches if\n  // 1) name matches\n  // 2) all named params are present\n  _matchRoute (input) {\n    const {route} = input;\n    const {name, params = {}} = route;\n\n    // Name of passed route must match this route's name\n    if (name !== this.name) {\n      return false;\n    }\n\n    const param_names = this._requiredParamNames();\n    const has_all_params = param_names.every((name)=> name in params);\n    if (!has_all_params) {\n      return false;\n    }\n\n    // All named params are present, its a match\n    return new MatchResult({\n      input,\n      route: this,\n      params\n    });\n  }\n\n  _getParamsFromMatch (match) {\n    const params = {};\n    const param_names = this._paramNames();\n\n    for (let i = 0; i < param_names.length; i++) {\n      // TODO: worth handling delim / repeat?\n      const {name, repeat, delimiter, optional} = this._param_keys[i];\n      const value = match[i + 1];\n      const defined = (value !== undefined);\n      let decoded = defined ? decodeParam({name, value}) : value;\n      if (repeat) {\n        decoded = decoded.split(delimiter);\n      }\n      if (defined || !optional) {\n        params[name] = decoded;\n      }\n    }\n\n    return params;\n  }\n\n  buildUrl (params = {}) {\n    let url = this._buildPath(params);\n    const query = this._buildQuery(params);\n    if (query.length) {\n      url = `${url}?${query}`;\n    }\n    return url;\n  }\n\n  _buildPath (params) {\n    const {pattern} = this;\n    const buildPath = compile(pattern);\n    return buildPath(params);\n  }\n\n  _buildQuery (params) {\n    const param_names = this._paramNames();\n\n    const query_params = {};\n    for (const [name, value] of Object.entries(params)) {\n      if (!param_names.includes(name)) {\n        query_params[name] = value;\n      }\n    }\n\n    return Querystring.stringify(query_params);\n  }\n\n  _paramNames () {\n    return this._param_keys.map((k)=> k.name);\n  }\n\n  _requiredParamNames () {\n    return this._param_keys\n      .filter((k)=> !k.optional)\n      .map((k)=> k.name);\n  }\n}\n","import type from 'type-of-is';\n\nimport Route from './Route';\nimport MatchResult from './MatchResult';\n\nfunction omitter (keys) {\n  return function omit (obj) {\n    return Object.keys(obj).reduce((result, key)=> {\n      if (!keys.includes(key)) {\n        result[key] = obj[key];\n      }\n      return result;\n    }, {});\n  };\n}\n\nconst getExtra = omitter(['route', 'url']);\n\nexport default class Router {\n  constructor ({\n    routes,\n    redirects,\n    max_redirects = 10\n  }) {\n    this.routes = [];\n    this.addRoutes(routes);\n    this.max_redirects = max_redirects;\n\n    this.redirects = [];\n    for (const [name, test] of Object.entries(redirects)) {\n      this.redirects.push({name, test});\n    }\n\n    this.listeners = [];\n  }\n\n  addRoutes (routes) {\n    const entries = Object.entries(routes);\n    for (const [name, config] of entries) {\n      config.name = name;\n      const route = new Route(config);\n      this.routes.push(route);\n    }\n  }\n\n  getRoute (query) {\n    return this.routes.find((route)=> {\n      return Object.entries(query).every(([k, v])=> {\n        return (route[k] === v);\n      });\n    });\n  }\n\n  getRouteByName (name) {\n    const route = this.getRoute({name});\n    if (!route) {\n      throw new Error(`No route named ${name}`);\n    }\n    return route;\n  }\n\n  // match\n  // -----\n  // Checks whether there is a route matching the passed pathname\n  // If there is a match, returns the associated Page and matched params.\n  // If no match return NotFound\n  match (input) {\n    input = this._normalizeInput(input);\n    const extra = getExtra(input);\n    const original = this._match(input);\n    const redirect = this._checkRedirects({original, extra});\n    if (redirect) {\n      redirect.isRedirect({original});\n      return redirect;\n    } else {\n      return original;\n    }\n  }\n\n  _normalizeInput (input) {\n    switch (type(input)) {\n      case String:\n        if (input.indexOf('/') !== -1) {\n          return {url: input};\n        } else {\n          return {route: {name: input}};\n        }\n      case Object:\n        if (input.name) {\n          return {route: input};\n        } else {\n          return input;\n        }\n      default:\n        throw new Error('Invalid input');\n    }\n  }\n\n  _match (input) {\n    // if passed full url, treat as redirect\n    const {url} = input;\n    if (url && url.match(/^https?:\\/\\//)) {\n      return new MatchResult({\n        redirect: true,\n        input,\n        url\n      });\n    }\n\n    let match = null;\n    for (const r of this.routes) {\n      match = r.match(input);\n      if (match) {\n        break;\n      }\n    }\n\n    return match;\n  }\n\n  _checkRedirects ({\n    original,\n    extra,\n    previous = null,\n    current = null,\n    num_redirects = 0,\n    history = []\n  }) {\n    const {max_redirects} = this;\n    if (num_redirects >= max_redirects) {\n      throw new Error(`Number of redirects exceeded max_redirects (${max_redirects})`);\n    }\n\n    function deepEqual (a, b) {\n      const {stringify} = JSON;\n      return (stringify(a) === stringify(b));\n    }\n\n    // if current is the same as original, then we've looped, so this shouldn't\n    // be a redirect\n    // TODO: improve cycle detection\n    if (current && previous) {\n      const same_route = (current.route === previous.route);\n      const same_params = deepEqual(current.params, previous.params);\n      if (same_route && same_params) {\n        return previous;\n      }\n    }\n\n    if (!current) {\n      current = original;\n      history = [original];\n    }\n\n    if (current.redirect) {\n      return current;\n    }\n\n    let next = false;\n    if (current && current.route.redirect) {\n      next = current.route.redirect(current);\n    }\n\n    if (!next) {\n      for (const {test} of this.redirects) {\n        // test returns false if no redirect is needed\n        next = test(current);\n        if (next) {\n          break;\n        }\n      }\n    }\n\n    if (next) {\n      // we got a redirect\n      previous = current;\n      next = this._normalizeInput(next);\n      current = this._match({...next, ...extra});\n      if (!current) {\n        throw new Error(`No match for redirect result ${next}`);\n      }\n      history.push(current);\n      num_redirects++;\n      return this._checkRedirects({original, previous, current, num_redirects, history, extra});\n    } else if (num_redirects > 0) {\n      return current;\n    } else {\n      return false;\n    }\n  }\n\n  onChange (listener) {\n    this.listeners.push(listener);\n  }\n\n  go (input) {\n    const match = this.match(input);\n    const {url} = match;\n    for (const listener of this.listeners) {\n      listener(url);\n    }\n  }\n}\n"],"names":["MatchResult","constructor","input","route","url","params","redirect","original","buildUrl","isRedirect","decodeParam","name","value","decodeURIComponent","_","Error","Route","required_params","param","k","v","Object","entries","includes","options","sensitive","strict","end","_param_keys","_matcher","pathToRegexp","pattern","match","args","fn_name","is","test","indexOf","exec","_matchUrl","query","query_params","pathname","path","Url","parse","route_params","_getParamsFromMatch","_matchRoute","param_names","_requiredParamNames","has_all_params","every","_paramNames","i","length","repeat","delimiter","optional","defined","undefined","decoded","split","_buildPath","_buildQuery","buildPath","compile","Querystring","stringify","map","filter","omitter","keys","omit","obj","reduce","result","key","getExtra","Router","routes","redirects","max_redirects","addRoutes","push","listeners","config","getRoute","find","getRouteByName","_normalizeInput","extra","_match","_checkRedirects","type","String","r","previous","current","num_redirects","history","deepEqual","a","b","JSON","same_route","same_params","next","onChange","listener","go"],"mappings":"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"}