{"version":3,"file":"index.umd.js","sources":["../src/logger.js","../src/MatchResult.js","../src/Route.js","../src/Router.js"],"sourcesContent":["import Logger from '@hello10/logger';\n\nconst logger = new Logger('groutcho');\n\nexport default logger;\n","export default class MatchResult {\n  constructor ({\n    input,\n    route = null,\n    url = null,\n    params = {},\n    redirect = false\n  }) {\n    this.input = input;\n    this.route = route;\n    this.params = params;\n    this.redirect = redirect;\n    this.original = null;\n    this.url = url || route.buildUrl(params);\n  }\n\n  isRedirect ({original}) {\n    this.redirect = true;\n    this.original = original;\n  }\n}\n","import Url from 'url';\nimport Querystring from 'querystring';\nimport {pathToRegexp, compile} from 'path-to-regexp';\n\nimport MatchResult from './MatchResult';\n\nexport default class Route {\n  /**\n   * Represents a route\n   * @constructor\n   * @param {string} name - Name for the route.\n   * @param {string} pattern - Pattern used by path-to-regexp to match route.\n   * @param {Object} page - Page to be returned along with params for this route.\n   */\n  constructor (params) {\n    const required_params = ['name', 'pattern', 'page'];\n    for (const param of required_params) {\n      if (!(param in params)) {\n        throw new Error(`Missing route param ${param}`);\n      }\n    }\n\n    // Allow for dynamic params in routes to be used with\n    // custom redirects etc.\n    for (const [k, v] of Object.entries(params)) {\n      if (['is', 'match', 'buildUrl'].includes(k)) {\n        throw new Error(`Invalid route param ${k}`);\n      }\n      this[k] = v;\n    }\n\n    // create matcher for this route (uses path-to-regexp)\n    const options = {\n      sensitive: false,\n      strict: false,\n      end: true\n    };\n    this._param_keys = [];\n    this._matcher = pathToRegexp(this.pattern, this._param_keys, options);\n  }\n\n  /**\n  * Check whether this route matches a passed path or route.\n  * @return {MatchedRoute}\n  */\n  // you can either pass a path to match\n  match (args) {\n    const fn_name = `_match${args.url ? 'Url' : 'Route'}`;\n    return this[fn_name](args);\n  }\n\n  is (test) {\n    if (test.indexOf('/') !== -1) {\n      return !!this._matcher.exec(test);\n    } else {\n      return (this.name === test);\n    }\n  }\n\n  _matchUrl (input) {\n    const {url} = input;\n\n    const {\n      query: query_params,\n      pathname: path\n    } = Url.parse(url, true);\n\n    const match = this._matcher.exec(path);\n    if (!match) {\n      return false;\n    }\n\n    const route_params = this._getParamsFromMatch(match);\n    const params = {...route_params, ...query_params};\n\n    return new MatchResult({\n      route: this,\n      input,\n      params\n    });\n  }\n\n  // matches if\n  // 1) name matches\n  // 2) all named params are present\n  _matchRoute (input) {\n    const {route} = input;\n    const {name, params = {}} = route;\n\n    // Name of passed route must match this route's name\n    if (name !== this.name) {\n      return false;\n    }\n\n    const param_names = this._requiredParamNames();\n    const has_all_params = param_names.every((name)=> name in params);\n    if (!has_all_params) {\n      return false;\n    }\n\n    // All named params are present, its a match\n    return new MatchResult({\n      input,\n      route: this,\n      params\n    });\n  }\n\n  _getParamsFromMatch (match) {\n    const params = {};\n    const param_names = this._paramNames();\n\n    for (let i = 0; i < param_names.length; i++) {\n      // TODO: worth handling delim / repeat?\n      const {name, repeat, delimiter, optional} = this._param_keys[i];\n      const value = match[i + 1];\n      const defined = (value !== undefined);\n      let decoded = defined ? decodeURIComponent(value) : value;\n      if (repeat) {\n        decoded = decoded.split(delimiter);\n      }\n      if (defined || !optional) {\n        params[name] = decoded;\n      }\n    }\n\n    return params;\n  }\n\n  buildUrl (params = {}) {\n    let url = this._buildPath(params);\n    const query = this._buildQuery(params);\n    if (query.length) {\n      url = `${url}?${query}`;\n    }\n    return url;\n  }\n\n  _buildPath (params) {\n    const {pattern} = this;\n    const buildPath = compile(pattern);\n    return buildPath(params);\n  }\n\n  _buildQuery (params) {\n    const param_names = this._paramNames();\n\n    const query_params = {};\n    for (const [name, value] of Object.entries(params)) {\n      if (!param_names.includes(name)) {\n        query_params[name] = value;\n      }\n    }\n\n    return Querystring.stringify(query_params);\n  }\n\n  _paramNames () {\n    return this._param_keys.map((k)=> k.name);\n  }\n\n  _requiredParamNames () {\n    return this._param_keys\n      .filter((k)=> !k.optional)\n      .map((k)=> k.name);\n  }\n}\n","import type from 'type-of-is';\nimport {omitter} from '@hello10/util';\n\nimport logger from './logger';\nimport Route from './Route';\nimport MatchResult from './MatchResult';\n\nconst getExtra = omitter(['route', 'url']);\n\nexport default class Router {\n  constructor ({\n    routes,\n    redirects,\n    max_redirects = 10\n  }) {\n    this.routes = [];\n    this.addRoutes(routes);\n    this.max_redirects = max_redirects;\n\n    this.redirects = [];\n    for (const [name, test] of Object.entries(redirects)) {\n      this.redirects.push({name, test});\n    }\n\n    this.listeners = [];\n    logger.debug('Constructed router', this);\n  }\n\n  addRoutes (routes) {\n    const entries = Object.entries(routes);\n    for (const [name, config] of entries) {\n      config.name = name;\n      const route = new Route(config);\n      logger.debug('Adding route', route);\n      this.routes.push(route);\n    }\n  }\n\n  getRoute (query) {\n    return this.routes.find((route)=> {\n      return Object.entries(query).every(([k, v])=> {\n        return (route[k] === v);\n      });\n    });\n  }\n\n  getRouteByName (name) {\n    const route = this.getRoute({name});\n    if (!route) {\n      const msg = `No route named ${name}`;\n      logger.error(msg);\n      throw new Error(msg);\n    }\n    return route;\n  }\n\n  // match\n  // -----\n  // Checks whether there is a route matching the passed pathname\n  // If there is a match, returns the associated Page and matched params.\n  // If no match return NotFound\n  match (input) {\n    input = this.normalizeInput(input);\n    const extra = getExtra(input);\n    const original = this._match(input);\n    const redirect = this._checkRedirects({original, extra});\n    logger.debug('match', {input, original, redirect});\n    if (redirect) {\n      redirect.isRedirect({original});\n      return redirect;\n    } else {\n      return original;\n    }\n  }\n\n  normalizeInput (input) {\n    switch (type(input)) {\n      case String:\n        if (input.indexOf('/') !== -1) {\n          return {url: input};\n        } else {\n          return {route: {name: input}};\n        }\n      case Object:\n        if (input.name) {\n          return {route: input};\n        } else {\n          return input;\n        }\n      default: {\n        const error = new Error('Invalid input');\n        error.input = input;\n        throw error;\n      }\n    }\n  }\n\n  _match (input) {\n    logger.debug('Attempting to match route', input);\n    // if passed full url, treat as redirect\n    const {url} = input;\n    if (url && url.match(/^https?:\\/\\//)) {\n      return new MatchResult({\n        redirect: true,\n        input,\n        url\n      });\n    }\n\n    let match = null;\n    for (const r of this.routes) {\n      match = r.match(input);\n      if (match) {\n        break;\n      }\n    }\n\n    return match;\n  }\n\n  _checkRedirects ({\n    original,\n    extra,\n    previous = null,\n    current = null,\n    num_redirects = 0,\n    history = []\n  }) {\n    logger.debug('Checking redirects', {original, extra, previous, current, num_redirects, history});\n    const {max_redirects} = this;\n    if (num_redirects >= max_redirects) {\n      const msg = `Number of redirects exceeded max_redirects (${max_redirects})`;\n      logger.error(msg);\n      throw new Error(msg);\n    }\n\n    function deepEqual (a, b) {\n      const {stringify} = JSON;\n      return (stringify(a) === stringify(b));\n    }\n\n    // if current is the same as original, then we've looped, so this shouldn't\n    // be a redirect\n    // TODO: improve cycle detection\n    if (current && previous) {\n      const same_route = (current.route === previous.route);\n      const same_params = deepEqual(current.params, previous.params);\n      if (same_route && same_params) {\n        logger.debug('Route is same as previous', {current, previous});\n        return previous;\n      }\n    }\n\n    if (!current) {\n      current = original;\n      history = [original];\n    }\n\n    if (current.redirect) {\n      return current;\n    }\n\n    let next = false;\n    if (current && current.route.redirect) {\n      next = current.route.redirect(current);\n    }\n\n    if (!next) {\n      for (const {test} of this.redirects) {\n        // test returns false if no redirect is needed\n        next = test(current);\n        if (next) {\n          break;\n        }\n      }\n    }\n\n    if (next) {\n      logger.debug('Got redirect', {current, next});\n      // we got a redirect\n      previous = current;\n      next = this.normalizeInput(next);\n      current = this._match({...next, ...extra});\n      if (!current) {\n        const error = new Error('No match for redirect result');\n        error.redirect = next;\n        throw error;\n      }\n      history.push(current);\n      num_redirects++;\n      return this._checkRedirects({original, previous, current, num_redirects, history, extra});\n    } else if (num_redirects > 0) {\n      return current;\n    } else {\n      return false;\n    }\n  }\n\n  onGo (listener) {\n    this.listeners.push(listener);\n  }\n\n  go (input) {\n    const match = this.match(input);\n    for (const listener of this.listeners) {\n      listener(match);\n    }\n    return match;\n  }\n}\n"],"names":["logger","Logger","MatchResult","constructor","input","route","url","params","redirect","original","buildUrl","isRedirect","Route","required_params","param","Error","k","v","Object","entries","includes","options","sensitive","strict","end","_param_keys","_matcher","pathToRegexp","pattern","match","args","fn_name","is","test","indexOf","exec","name","_matchUrl","query","query_params","pathname","path","Url","parse","route_params","_getParamsFromMatch","_matchRoute","param_names","_requiredParamNames","has_all_params","every","_paramNames","i","length","repeat","delimiter","optional","value","defined","undefined","decoded","decodeURIComponent","split","_buildPath","_buildQuery","buildPath","compile","Querystring","stringify","map","filter","getExtra","omitter","Router","routes","redirects","max_redirects","addRoutes","push","listeners","debug","config","getRoute","find","getRouteByName","msg","error","normalizeInput","extra","_match","_checkRedirects","type","String","r","previous","current","num_redirects","history","deepEqual","a","b","JSON","same_route","same_params","next","onGo","listener","go"],"mappings":"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"}